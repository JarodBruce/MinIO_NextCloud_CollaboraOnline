---
# Collabora Online ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: collabora-config
  namespace: cloud-storage
data:
  domain: "nextcloud\\.jarodbruce\\.f5\\.si|nextcloud\\.cloud-storage\\.svc\\.cluster\\.local"
  username: "admin"
  password: "admin123"
  extra_params: "--o:ssl.enable=false --o:ssl.termination=true --o:storage.wopi.host[0]=nextcloud.cloud-storage.svc.cluster.local --o:storage.wopi.host[1]=nextcloud.jarodbruce.f5.si"

---
# Collabora Proof Key Secret (generate with: ssh-keygen -t rsa -N "" -m PEM -f proof_key)
# To create this secret, run:
# kubectl create secret generic collabora-proof-key \
#   --from-file=proof_key=./proof_key \
#   --from-file=proof_key.pub=./proof_key.pub \
#   -n cloud-storage
apiVersion: v1
kind: Secret
metadata:
  name: collabora-proof-key
  namespace: cloud-storage
type: Opaque
stringData:
  # デフォルトの空のproof_keyを提供（本番環境では実際の鍵を生成して使用してください）
  proof_key: |
    -----BEGIN RSA PRIVATE KEY-----
    MIIEpAIBAAKCAQEAw8vHrhrHfYbFfCHMYPQYdFhTZQrVNTzLvCj3+9Wm0f3sxJYv
    /6s1/+xR8YxPh6bYGQ5tK4wQb5YT0dXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLk
    YdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXd
    XZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYd
    GF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZ
    mVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF
    7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmV
    LkYdGF7nXdXZmQIDAQABAoIBAEw8j5YxqvJT5tGXZj8JT5tGXZj8JT5tGXZj8JT5
    tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5t
    GXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tG
    XZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGX
    Zj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZ
    j8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj
    8JT5tGXZkECgYEA8YxPh6bYGQ5tK4wQb5YT0dXZmVLkYdGF7nXdXZmVLkYdGF7nXd
    XZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYd
    GF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZ
    mVLkYdGF7nXdXZkECgYEAzs1/+xR8YxPh6bYGQ5tK4wQb5YT0dXZmVLkYdGF7nXdX
    ZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF
    7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVLkYdGF7nXdXZmVL
    kYdGF7nXdXZmQKBgQCvJT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8J
    T5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5
    tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tG
    XZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JQKBgQCj5YxqvJT5tGXZj8JT5tGXZj8JT5
    tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tG
    XZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZ
    j8JT5tGXZj8JT5tGXZj8JT5tGXZj8JQKBgQCw8j5YxqvJT5tGXZj8JT5tGXZj8JT5
    tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tG
    XZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZj8JT5tGXZ
    j8JT5tGXZj8JT5tGXZj8JT5tGXZg==
    -----END RSA PRIVATE KEY-----
  proof_key.pub: |
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDDy8euGsd9hsV8Icxg9Bh0WFNlCtU1PMu8KPf71abR/ezEli//qzX/7FHxjE+HptgZDm0rjBBvlhPR1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZUuRh0YXudd1dmZQ==

---
# Collabora Online Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: collabora
  namespace: cloud-storage
  labels:
    app: collabora
spec:
  replicas: 1
  selector:
    matchLabels:
      app: collabora
  template:
    metadata:
      labels:
        app: collabora
    spec:
      # セキュリティコンテキストを追加
      securityContext:
        fsGroup: 101  # cool グループ
        runAsNonRoot: false  # coolforkit needs root to spawn child processes
      
      volumes:
      - name: cool-tmp
        emptyDir:
          medium: Memory
          sizeLimit: 512Mi
      - name: cool-child-roots
        emptyDir:
          medium: Memory
          sizeLimit: 1Gi
      - name: proof-key
        secret:
          secretName: collabora-proof-key
          defaultMode: 0600
      
      containers:
      - name: collabora
        image: collabora/code:latest
        env:
        - name: domain
          valueFrom:
            configMapKeyRef:
              name: collabora-config
              key: domain
        - name: username
          valueFrom:
            configMapKeyRef:
              name: collabora-config
              key: username
        - name: password
          valueFrom:
            configMapKeyRef:
              name: collabora-config
              key: password
        - name: extra_params
          valueFrom:
            configMapKeyRef:
              name: collabora-config
              key: extra_params
        - name: dictionaries
          value: "en_US ja"
        
        ports:
        - containerPort: 9980
          name: http
        
        volumeMounts:
        - name: cool-tmp
          mountPath: /opt/cool/systemplate
        - name: cool-child-roots
          mountPath: /opt/cool/child-roots
        - name: proof-key
          mountPath: /etc/coolwsd/proof_key
          subPath: proof_key
          readOnly: true
        - name: proof-key
          mountPath: /etc/coolwsd/proof_key.pub
          subPath: proof_key.pub
          readOnly: true
        
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        
        livenessProbe:
          httpGet:
            path: /
            port: 9980
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
        
        readinessProbe:
          httpGet:
            path: /
            port: 9980
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        
        # securityContext を Pod レベルに移動し、コンテナレベルでは削除
        securityContext:
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: false
          capabilities:
            add:
            - MKNOD
            - SYS_CHROOT
            - FOWNER
            - CHOWN
            - SYS_ADMIN

---
# Collabora Online Service
apiVersion: v1
kind: Service
metadata:
  name: collabora
  namespace: cloud-storage
  labels:
    app: collabora
spec:
  type: ClusterIP
  ports:
  - port: 9980
    targetPort: 9980
    name: http
  selector:
    app: collabora
