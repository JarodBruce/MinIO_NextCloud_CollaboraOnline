# Cloudflare Access è¨­å®šã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€NextCloudã€Immichã€Collabora Onlineã«Cloudflare Accessã‚’çµ±åˆã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
- [Cloudflare Accessã¨ã¯](#cloudflare-accessã¨ã¯)
- [è¨­å®šæ‰‹é †](#è¨­å®šæ‰‹é †)
- [å„ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®š](#å„ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®š)
- [èªè¨¼æ–¹å¼ã®é¸æŠ](#èªè¨¼æ–¹å¼ã®é¸æŠ)
- [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

## ğŸ¯ æ¦‚è¦

Cloudflare Accessã¯ã€ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ‡ãƒ«ã«åŸºã¥ã„ãŸèªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚VPNãªã—ã§ã€ä¸–ç•Œä¸­ã©ã“ã‹ã‚‰ã§ã‚‚å®‰å…¨ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

### ä¸»ãªæ©Ÿèƒ½

- âœ… **çµ±ä¸€ã•ã‚ŒãŸèªè¨¼**: ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã§åŒã˜èªè¨¼ãƒ•ãƒ­ãƒ¼
- âœ… **å¤šè¦ç´ èªè¨¼(MFA)**: TOTPã‚„ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚­ãƒ¼ã®ã‚µãƒãƒ¼ãƒˆ
- âœ… **SSOçµ±åˆ**: Googleã€Microsoftã€Oktaãªã©ã¨é€£æº
- âœ… **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†
- âœ… **è©³ç´°ãªãƒ­ã‚°**: ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œã‚’è¨˜éŒ²
- âœ… **åœ°ç†çš„åˆ¶é™**: å›½åˆ¥ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- âœ… **ãƒ‡ãƒã‚¤ã‚¹èªè¨¼**: ä¿¡é ¼ã§ãã‚‹ãƒ‡ãƒã‚¤ã‚¹ã®ã¿è¨±å¯

## ğŸ“¦ å‰ææ¡ä»¶

- Cloudflare ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³ã§OKï¼‰
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒCloudflareã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹
- Cloudflare TunnelãŒè¨­å®šæ¸ˆã¿
- NextCloudã€Immichã€CollaboraãŒãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿

## ğŸ” Cloudflare Accessã¨ã¯

Cloudflare Accessã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‰ã«èªè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é…ç½®ã—ã€è¨±å¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼
   â†“
Cloudflare Accessï¼ˆèªè¨¼ï¼‰
   â†“
Cloudflare Tunnel
   â†“
ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
```

### ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®åˆ¶é™

- æœ€å¤§50ãƒ¦ãƒ¼ã‚¶ãƒ¼
- æœˆé–“æœ€å¤§10,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- åŸºæœ¬çš„ãªèªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆEmail OTPã€Googleç­‰ï¼‰

å€‹äººåˆ©ç”¨ã‚„å°è¦æ¨¡ãƒãƒ¼ãƒ ã«ã¯ååˆ†ã§ã™ã€‚

## ğŸš€ è¨­å®šæ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: Cloudflare Zero Trustãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹

1. [Cloudflare One Dashboard](https://one.dash.cloudflare.com/) ã«ãƒ­ã‚°ã‚¤ãƒ³
2. åˆå›ã®å ´åˆã€ãƒãƒ¼ãƒ åã‚’è¨­å®šï¼ˆä¾‹: `mycompany`ï¼‰
   - ã“ã‚ŒãŒèªè¨¼URLã«ãªã‚Šã¾ã™: `mycompany.cloudflareaccess.com`

### ã‚¹ãƒ†ãƒƒãƒ—2: èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š

æœ€åˆã«ã€èªè¨¼æ–¹æ³•ã‚’è¨­å®šã—ã¾ã™ã€‚

1. `Settings` â†’ `Authentication` â†’ `Login methods` ã«ç§»å‹•
2. `Add new` ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: One-time PINï¼ˆæœ€ã‚‚ç°¡å˜ï¼‰

- Name: `Email OTP`
- æœ‰åŠ¹åŒ–
- ã“ã‚Œã§ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«PINã‚³ãƒ¼ãƒ‰ãŒé€ä¿¡ã•ã‚Œã¾ã™

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: Googleèªè¨¼

- `Add new` â†’ `Google`
- Client ID ã¨ Client Secret ã‚’å…¥åŠ›ï¼ˆGoogle Cloud Consoleã§å–å¾—ï¼‰
- `Save` ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: ãã®ä»–ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼

- Microsoft Azure AD
- GitHub
- Okta
- SAML

### ã‚¹ãƒ†ãƒƒãƒ—3: NextCloudç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ

1. `Access` â†’ `Applications` â†’ `Add an application` ã‚’ã‚¯ãƒªãƒƒã‚¯

2. **Application Configuration**
   - Application name: `NextCloud`
   - Session duration: `24 hours`ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰
   - Application domain: `nextcloud.yourdomain.com`

3. **Identity providers**
   - è¨­å®šã—ãŸèªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é¸æŠï¼ˆä¾‹: Email OTPï¼‰

4. **Add a policy**
   - Policy name: `Allow authorized users`
   - Action: `Allow`
   
   **Includeè¦å‰‡ã‚’è¿½åŠ :**
   
   **ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: ç‰¹å®šã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**
   ```
   Selector: Emails
   Value: admin@example.com, user@example.com
   ```
   
   **ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: ãƒ‰ãƒ¡ã‚¤ãƒ³å…¨ä½“**
   ```
   Selector: Email domains
   Value: @yourcompany.com
   ```
   
   **ã‚ªãƒ—ã‚·ãƒ§ãƒ³C: ç‰¹å®šã®IPç¯„å›²**
   ```
   Selector: IP ranges
   Value: 203.0.113.0/24
   ```
   
   è¤‡æ•°ã®æ¡ä»¶ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

5. **Additional settingsï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**
   - Enable App in App Launcher: æœ‰åŠ¹åŒ–ï¼ˆæ¨å¥¨ï¼‰
   - Accept all available identity providers: æœ‰åŠ¹åŒ–

6. `Save application` ã‚’ã‚¯ãƒªãƒƒã‚¯

7. **Application Audience (AUD) Tagã‚’ã‚³ãƒ”ãƒ¼**
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆå¾Œã€`Overview`ã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œã¾ã™
   - ä¾‹: `a1b2c3d4e5f6g7h8i9j0`
   - ã“ã‚Œã‚’å¾Œã§ä½¿ç”¨ã—ã¾ã™

### ã‚¹ãƒ†ãƒƒãƒ—4: Immichç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ

NextCloudã¨åŒã˜æ‰‹é †ã§ã€Immichç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼š

- Application name: `Immich`
- Application domain: `immich.yourdomain.com`
- åŒã˜ãƒãƒªã‚·ãƒ¼ã¾ãŸã¯åˆ¥ã®ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®š
- AUD Tagã‚’ã‚³ãƒ”ãƒ¼

### ã‚¹ãƒ†ãƒƒãƒ—5: Collabora Onlineç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ

Collaboraã¯ç‰¹æ®Šãªè¨­å®šãŒå¿…è¦ã§ã™ï¼š

1. **åŸºæœ¬è¨­å®š**
   - Application name: `Collabora Online`
   - Application domain: `collabora.yourdomain.com`

2. **ãƒãƒªã‚·ãƒ¼è¨­å®š**
   
   2ã¤ã®ãƒãƒªã‚·ãƒ¼ãŒå¿…è¦ã§ã™ï¼š
   
   **ãƒãƒªã‚·ãƒ¼1: é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼**
   - Policy name: `Allow users`
   - Action: `Allow`
   - Include: Emailsï¼ˆNextCloudã¨åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
   
   **ãƒãƒªã‚·ãƒ¼2: NextCloudã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒã‚¤ãƒ‘ã‚¹**
   - Policy name: `Bypass from NextCloud`
   - Action: `Bypass`
   - Include: `IP ranges`
     - NextCloudã®Pod CIDRï¼ˆä¾‹: `10.42.0.0/16`ï¼‰
     - ã“ã‚Œã«ã‚ˆã‚Šã€NextCloudãŒCollaboraã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™

3. AUD Tagã‚’ã‚³ãƒ”ãƒ¼

### ã‚¹ãƒ†ãƒƒãƒ—6: MinIO Consoleç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ

ç®¡ç†è€…ã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«è¨­å®šï¼š

- Application name: `MinIO Console`
- Application domain: `minio.yourdomain.com`
- Policy: ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿è¨±å¯

### ã‚¹ãƒ†ãƒƒãƒ—7: Kubernetesè¨­å®šã®æ›´æ–°

1. **ConfigMapã‚’ç·¨é›†**

   `k8s/07-cloudflare-access.yaml` ã‚’ç·¨é›†ï¼š
   
   ```yaml
   data:
     CLOUDFLARE_ACCESS_TEAM_DOMAIN: "mycompany.cloudflareaccess.com"  # å®Ÿéš›ã®ãƒãƒ¼ãƒ å
     NEXTCLOUD_POLICY_AUD: "a1b2c3d4e5f6g7h8i9j0"  # NextCloudã®AUD Tag
     IMMICH_POLICY_AUD: "k1l2m3n4o5p6q7r8s9t0"     # Immichã®AUD Tag
     COLLABORA_POLICY_AUD: "u1v2w3x4y5z6a7b8c9d0"  # Collaboraã®AUD Tag
   ```

2. **Kubernetesã«é©ç”¨**
   
   ```bash
   kubectl apply -f k8s/07-cloudflare-access.yaml
   ```

3. **Podå†èµ·å‹•ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**
   
   è¨­å®šã‚’åæ˜ ã•ã›ã‚‹ãŸã‚ï¼š
   ```bash
   kubectl rollout restart deployment/nextcloud -n cloud-storage
   kubectl rollout restart deployment/immich-server -n cloud-storage
   kubectl rollout restart deployment/collabora -n cloud-storage
   ```

### ã‚¹ãƒ†ãƒƒãƒ—8: å‹•ä½œç¢ºèª

1. **ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã§é–‹ã**
   
   ```
   https://nextcloud.yourdomain.com
   ```

2. **Cloudflare Accessèªè¨¼ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹**
   - Email OTPã®å ´åˆ: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›
   - PINã‚³ãƒ¼ãƒ‰ãŒãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã•ã‚Œã‚‹
   - PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›

3. **NextCloudã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹**
   - èªè¨¼æˆåŠŸå¾Œã€é€šå¸¸é€šã‚ŠNextCloudãŒè¡¨ç¤ºã•ã‚Œã¾ã™

4. **ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚‚ç¢ºèª**
   - `https://immich.yourdomain.com`
   - `https://collabora.yourdomain.com`
   - `https://minio.yourdomain.com`

## âš™ï¸ å„ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®š

### NextCloudã®è¿½åŠ è¨­å®š

Cloudflare Accessã¨æ­£ã—ãå‹•ä½œã•ã›ã‚‹ãŸã‚ã€NextCloudã®è¨­å®šã‚’èª¿æ•´ï¼š

```bash
kubectl exec -it -n cloud-storage deployment/nextcloud -- bash
vi /var/www/html/config/config.php
```

ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```php
<?php
$CONFIG = array (
  // æ—¢å­˜ã®è¨­å®š...
  
  // Cloudflare Accessç”¨ã®è¨­å®š
  'trusted_proxies' => array(
    '10.0.0.0/8',  // Kuberneteså†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
    // Cloudflare IPãƒ¬ãƒ³ã‚¸ï¼ˆIPv4ï¼‰
    '173.245.48.0/20',
    '103.21.244.0/22',
    '103.22.200.0/22',
    '103.31.4.0/22',
    '141.101.64.0/18',
    '108.162.192.0/18',
    '190.93.240.0/20',
    '188.114.96.0/20',
    '197.234.240.0/22',
    '198.41.128.0/17',
    '162.158.0.0/15',
    '104.16.0.0/13',
    '104.24.0.0/14',
    '172.64.0.0/13',
    '131.0.72.0/22',
  ),
  
  'overwriteprotocol' => 'https',
  'overwrite.cli.url' => 'https://nextcloud.yourdomain.com',
  'overwritehost' => 'nextcloud.yourdomain.com',
  
  // Cloudflare Accessãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿¡é ¼
  'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
);
```

### Immichã®è¿½åŠ è¨­å®š

Immichã¯ç’°å¢ƒå¤‰æ•°ã§è¨­å®šæ¸ˆã¿ã®ãŸã‚ã€è¿½åŠ ä½œæ¥­ã¯ä¸è¦ã§ã™ã€‚

ãŸã ã—ã€èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ´»ç”¨ã—ãŸã„å ´åˆï¼š

```yaml
# k8s/05-immich.yaml
env:
- name: IMMICH_TRUSTED_PROXIES
  value: "10.42.0.0/16,10.43.0.0/16,173.245.48.0/20,..."
```

### Collaboraã®ç‰¹æ®Šè¨­å®š

Collaboraã¯ã€NextCloudã‹ã‚‰å†…éƒ¨çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãŸã‚ã€ãƒã‚¤ãƒ‘ã‚¹ãƒãƒªã‚·ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**

1. Cloudflare Accessã®Collaboraã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§`Bypass`ãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
2. `IP ranges`ã«NextCloudã®Pod CIDRãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹

**Pod CIDRã®ç¢ºèªæ–¹æ³•:**

```bash
# NextCloud Podã®IPã‚’ç¢ºèª
kubectl get pods -n cloud-storage -o wide | grep nextcloud

# ä¾‹: 10.42.1.5
# CIDR: 10.42.0.0/16ï¼ˆk3sã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
```

## ğŸ”‘ èªè¨¼æ–¹å¼ã®é¸æŠ

### Email OTPï¼ˆæ¨å¥¨: å€‹äººåˆ©ç”¨ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… è¨­å®šãŒæœ€ã‚‚ç°¡å˜
- âœ… è¿½åŠ ã®ã‚µãƒ¼ãƒ“ã‚¹ä¸è¦
- âœ… MFAã¨ã—ã¦æ©Ÿèƒ½

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- âŒ ãƒ¡ãƒ¼ãƒ«é…å»¶ãŒã‚ã‚‹å ´åˆã‚ã‚Š
- âŒ ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦

**è¨­å®šæ–¹æ³•:**

CloudflareãŒè‡ªå‹•çš„ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚è¿½åŠ è¨­å®šã¯ä¸è¦ã€‚

### Googleèªè¨¼ï¼ˆæ¨å¥¨: å°è¦æ¨¡ãƒãƒ¼ãƒ ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªSSOä½“é¨“
- âœ… Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¿åˆ©
- âœ… é«˜é€Ÿãªèªè¨¼

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- âŒ Google Cloud Consoleã§ã®è¨­å®šãŒå¿…è¦
- âŒ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå¿…è¦

**è¨­å®šæ‰‹é †:**

1. [Google Cloud Console](https://console.cloud.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆï¼ˆã¾ãŸã¯æ—¢å­˜ã®ã‚‚ã®ã‚’é¸æŠï¼‰
3. `APIs & Services` â†’ `Credentials` â†’ `Create Credentials` â†’ `OAuth 2.0 Client ID`
4. Application type: `Web application`
5. Authorized redirect URIs:
   ```
   https://mycompany.cloudflareaccess.com/cdn-cgi/access/callback
   ```
6. Client ID ã¨ Client Secret ã‚’ã‚³ãƒ”ãƒ¼
7. Cloudflare Dashboard â†’ `Settings` â†’ `Authentication` â†’ `Add new` â†’ `Google`
8. Client ID ã¨ Client Secret ã‚’è²¼ã‚Šä»˜ã‘

### Microsoft Azure ADï¼ˆæ¨å¥¨: ä¼æ¥­åˆ©ç”¨ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… Microsoft 365ã¨çµ±åˆ
- âœ… Active Directoryã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- âœ… é«˜åº¦ãªãƒãƒªã‚·ãƒ¼è¨­å®š

**è¨­å®šæ‰‹é †:**

[Cloudflareå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.cloudflare.com/cloudflare-one/identity/idp-integration/azuread/) ã‚’å‚ç…§

### GitHubï¼ˆæ¨å¥¨: é–‹ç™ºè€…å‘ã‘ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… é–‹ç™ºãƒãƒ¼ãƒ ã«æœ€é©
- âœ… Organizationå˜ä½ã§ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- âœ… è¨­å®šãŒç°¡å˜

**è¨­å®šæ‰‹é †:**

1. [GitHub Developer Settings](https://github.com/settings/developers) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. `New OAuth App` ã‚’ã‚¯ãƒªãƒƒã‚¯
3. Authorization callback URL:
   ```
   https://mycompany.cloudflareaccess.com/cdn-cgi/access/callback
   ```
4. Client ID ã¨ Client Secret ã‚’ã‚³ãƒ”ãƒ¼
5. Cloudflareã«è¨­å®š

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### èªè¨¼ãƒ«ãƒ¼ãƒ—ãŒç™ºç”Ÿã™ã‚‹

**ç—‡çŠ¶:** Cloudflare Accessèªè¨¼å¾Œã€NextCloudã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ãŒã€å†ã³Cloudflare Accessã«æˆ»ã•ã‚Œã‚‹ã€‚

**åŸå› :** NextCloudãŒãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’æ­£ã—ãèªè­˜ã—ã¦ã„ãªã„ã€‚

**è§£æ±ºæ–¹æ³•:**

```bash
kubectl exec -it -n cloud-storage deployment/nextcloud -- bash
vi /var/www/html/config/config.php

# trusted_proxies ã‚’è¿½åŠ ï¼ˆä¸Šè¨˜ã®NextCloudè¨­å®šã‚’å‚ç…§ï¼‰
```

### Collaboraã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„

**ç—‡çŠ¶:** NextCloudã‹ã‚‰Collabora Onlineã§æ–‡æ›¸ã‚’é–‹ã“ã†ã¨ã™ã‚‹ã¨å¤±æ•—ã™ã‚‹ã€‚

**åŸå› :** Collaboraã®Bypassãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã€‚

**è§£æ±ºæ–¹æ³•:**

1. Cloudflare Dashboard â†’ `Access` â†’ `Applications` â†’ `Collabora Online`
2. Policyã«`Bypass`ã‚’è¿½åŠ 
3. `IP ranges`: NextCloudã®Pod CIDRï¼ˆ`10.42.0.0/16`ï¼‰

### Immichã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¤±æ•—ã™ã‚‹

**ç—‡çŠ¶:** å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã€‚

**åŸå› :** Cloudflare Accessã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒçŸ­ã„ã€‚

**è§£æ±ºæ–¹æ³•:**

1. Immich Applicationã®è¨­å®šã‚’é–‹ã
2. Session duration: `8 hours` ä»¥ä¸Šã«è¨­å®š
3. Cloudflare Dashboard â†’ `Rules` â†’ `Configuration Rules`
4. æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆ:
   - If: `Hostname equals immich.yourdomain.com`
   - Then: `Timeout = 300 seconds`ï¼ˆ5åˆ†ï¼‰

### MinIO ConsoleãŒå‹•ä½œã—ãªã„

**ç—‡çŠ¶:** MinIO Consoleã«ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã€‚

**åŸå› :** WebSocketãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã€‚

**è§£æ±ºæ–¹æ³•:**

1. Cloudflare Dashboard â†’ `Network`
2. `WebSockets`: æœ‰åŠ¹åŒ–
3. MinIO Applicationè¨­å®š:
   - CORS settings: `Allow all origins`ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰

### ã€ŒAccess Deniedã€ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:** èªè¨¼å¾Œã€ã€ŒAccess Deniedã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚

**åŸå› :** ãƒãƒªã‚·ãƒ¼ã«è©²å½“ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€‚

**è§£æ±ºæ–¹æ³•:**

1. Cloudflare Dashboard â†’ `Access` â†’ `Applications`
2. è©²å½“ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèª
3. Includeè¦å‰‡ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã‚‹

**ç—‡çŠ¶:** é »ç¹ã«å†èªè¨¼ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚

**è§£æ±ºæ–¹æ³•:**

1. Applicationè¨­å®šã§`Session duration`ã‚’é•·ãã™ã‚‹ï¼ˆä¾‹: `24 hours`ï¼‰
2. `Settings` â†’ `Authentication` â†’ `Refresh window`ã‚’è¨­å®š

## ğŸ“Š ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®ç¢ºèª

Cloudflare Accessã¯è©³ç´°ãªãƒ­ã‚°ã‚’æä¾›ã—ã¾ã™ã€‚

1. `Logs` â†’ `Access` ã«ç§»å‹•
2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°:
   - Application
   - User
   - Action (Allow/Block)
   - Time range

**ãƒ­ã‚°ã«å«ã¾ã‚Œã‚‹æƒ…å ±:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- ã‚¢ã‚¯ã‚»ã‚¹æ™‚åˆ»
- IPã‚¢ãƒ‰ãƒ¬ã‚¹
- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±
- èªè¨¼çµæœï¼ˆè¨±å¯/æ‹’å¦ï¼‰

## ğŸ¯ é«˜åº¦ãªè¨­å®š

### ãƒ‡ãƒã‚¤ã‚¹èªè¨¼

ç‰¹å®šã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ï¼š

1. `Settings` â†’ `WARP Client` â†’ `Device enrollment`
2. ãƒãƒªã‚·ãƒ¼ã«`Require WARP`ã‚’è¿½åŠ 

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

```
Settings â†’ Authentication â†’ Session timeout
- Idle timeout: 30 minutes
- Maximum session duration: 24 hours
```

### å›½åˆ¥åˆ¶é™

ãƒãƒªã‚·ãƒ¼ã«è¿½åŠ ï¼š
```
Include: Country â†’ Japan
Exclude: Country â†’ (ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸã„å›½)
```

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Cloudflare Access Documentation](https://developers.cloudflare.com/cloudflare-one/policies/access/)
- [Identity Provider Integration](https://developers.cloudflare.com/cloudflare-one/identity/idp-integration/)
- [Access Policy Configuration](https://developers.cloudflare.com/cloudflare-one/policies/access/policy-management/)

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:** [é‹ç”¨ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹](../README.md#é‹ç”¨ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹)
